{{- /* Head custom content area start */ -}}
{{- /*     Insert any custom code (web-analytics, resources, etc.) - it will appear in the <head></head> section of every page. */ -}}
{{- /*     Can be overwritten by partial with the same name in the global layouts. */ -}}
<script defer>
  console.log('Image retry script loading...');

  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - initializing image retry...');

    if (window.retryImagesInitialized) {
      console.log('Image retry already initialized');
      return;
    }
    window.retryImagesInitialized = true;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          observer.unobserve(img);
          retryImage(img);
        }
      });
    }, {
      rootMargin: '50px'
    });

    function retryImage(img, attempt = 1) {
      const maxAttempts = 5;
      const baseDelay = 5000;
      console.log('Checking image:', img.currentSrc, 'attempt:', attempt);

      fetch(img.currentSrc, { method: 'HEAD' })
        .then(response => {
          console.log('Response status:', response.status);
          if (response.status === 429 && attempt < maxAttempts) {
            const delay = baseDelay * attempt;
            console.log(`Will retry in ${delay/1000}s:`, img.currentSrc);
            setTimeout(() => retryImage(img, attempt + 1), delay);
          } else if (response.status === 200) {
            // Force browser to reload the image by adding/updating timestamp
            const timestamp = new Date().getTime();
            const url = new URL(img.currentSrc);
            url.searchParams.set('t', timestamp);
            img.src = url.toString();
            console.log('Image updated:', url.toString());
          }
        })
        .catch(error => {
          console.error('Retry check failed:', error);
        });
    }

    const images = document.querySelectorAll('img.retry-on-429');
    console.log('Found retry-enabled images:', images.length);

    images.forEach(img => {
      console.log('Observing image:', img.currentSrc);
      observer.observe(img);
    });
  });
</script>
{{- /* Head custom content area end */ -}}
